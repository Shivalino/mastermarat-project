//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\config\constants.js

// config/constants.js
export const API_VERSION = '1.0.0';

// Токены для тестирования
export const TEST_TOKENS = {
  // SuperUser - полный доступ ко всему
  SUPER_USER: 'superuser_mastermarat_2025',
  
  // Токены по типам подписки
  VIP_USER: 'vip_test_token_2025',
  STANDARD_USER: 'standard_test_token_2025',
  BASIC_USER: 'basic_test_token_2025',
  
  // Специальные токены
  DEMO_USER: 'demo123',
  EXPIRED_USER: 'expired_test_token',
  INVALID_USER: 'invalid_token'
};

// Права доступа по типам токенов
export const TOKEN_PERMISSIONS = {
  [TEST_TOKENS.SUPER_USER]: {
    type: 'superuser',
    access: 'all',
    courses: ['*'],
    features: ['player', 'archive', 'download', 'admin'],
    expires: '2099-12-31'
  },
  [TEST_TOKENS.VIP_USER]: {
    type: 'vip',
    access: 'full',
    courses: ['course1', 'course2', 'course3'],
    features: ['player', 'archive', 'consultation'],
    expires: '2025-12-31'
  },
  [TEST_TOKENS.STANDARD_USER]: {
    type: 'standard',
    access: 'standard',
    courses: ['course1'],
    features: ['player', 'archive'],
    expires: '2025-12-31'
  },
  [TEST_TOKENS.BASIC_USER]: {
    type: 'basic',
    access: 'basic',
    courses: ['course1'],
    features: ['player'],
    expires: '2025-12-31'
  },
  [TEST_TOKENS.DEMO_USER]: {
    type: 'demo',
    access: 'limited',
    courses: ['course1'],
    features: ['player'],
    expires: '2025-07-31'
  },
  [TEST_TOKENS.EXPIRED_USER]: {
    type: 'expired',
    access: 'none',
    courses: [],
    features: [],
    expires: '2024-12-31'
  }
};

// URL конфигурация
export const API_CONFIG = {
  CORS_ORIGIN: '*',
  CACHE_TTL: 3600,
  VIDEO_CHUNK_SIZE: 1024 * 1024, // 1MB chunks
  MAX_RANGE_SIZE: 10 * 1024 * 1024 // 10MB max range
};

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\config\courses.js
// config/courses.js
export const COURSE_DATA = {
  "course1": {
    title: "Механика здоровья",
    lessons: {
      "week1_lesson1": {
        title: "Введение в биомеханику тела",
        video_file: "week1_lesson1.mp4",
        thumbnail_file: "week1_lesson1.jpg",
        content_points: [
          "Что такое биомеханика и почему она важна для здоровья",
          "Основные принципы работы опорно-двигательного аппарата",
          "Как неправильные движения влияют на наше самочувствие"
        ],
        important_notes: "Это вводное занятие не требует специальной подготовки. Рекомендуем просмотреть видео полностью перед началом практических упражнений.",
        additional_info: "После просмотра этого урока вы будете лучше понимать, как работает ваше тело и почему важно следить за правильностью движений в повседневной жизни."
      },
      "week1_lesson2": {
        title: "Основы правильной осанки",
        video_file: "week1_lesson2.mp4",
        thumbnail_file: "week1_lesson2.jpg",
        content_points: [
          "Анатомия позвоночника и его естественные изгибы",
          "Признаки правильной и неправильной осанки",
          "Простые упражнения для улучшения осанки"
        ],
        important_notes: "Выполняйте упражнения перед зеркалом для контроля правильности положения тела. При болях в спине проконсультируйтесь с врачом.",
        additional_info: "Правильная осанка - основа здоровья всего организма. Уделяйте внимание осанке в течение всего дня, особенно при работе за компьютером."
      },
      "week2_lesson1": {
        title: "Работа с позвоночником",
        video_file: "week2_lesson1.mp4",
        thumbnail_file: "week2_lesson1.jpg",
        content_points: [
          "Безопасная мобилизация позвоночника",
          "Упражнения для каждого отдела позвоночника",
          "Техники снятия напряжения в спине"
        ],
        important_notes: "Все движения выполняйте плавно, без рывков. При головокружении прекратите выполнение упражнений.",
        additional_info: "Регулярная практика этих упражнений поможет улучшить гибкость позвоночника и снизить риск болей в спине."
      },
      "week2_lesson2": {
        title: "Упражнения для шеи",
        video_file: "week2_lesson2.mp4",
        thumbnail_file: "week2_lesson2.jpg",
        content_points: [
          "Анатомия шейного отдела и его особенности",
          "Безопасные упражнения для снятия напряжения в шее",
          "Профилактика головных болей напряжения"
        ],
        important_notes: "Упражнения для шеи требуют особой осторожности. Не делайте резких движений и круговых вращений головой.",
        additional_info: "Эти упражнения особенно полезны для людей, работающих за компьютером. Выполняйте их каждые 2-3 часа в течение рабочего дня."
      },
      "week3_lesson1": {
        title: "Техники самомассажа",
        video_file: "week3_lesson1.mp4",
        thumbnail_file: "week3_lesson1.jpg",
        content_points: [
          "Основные приемы самомассажа",
          "Работа с триггерными точками",
          "Использование подручных средств для массажа"
        ],
        important_notes: "При самомассаже избегайте сильного давления на позвоночник, лимфоузлы и области с воспалениями.",
        additional_info: "Самомассаж - эффективный способ снятия мышечного напряжения. Лучшее время для массажа - после теплого душа или ванны."
      },
      "week3_lesson2": {
        title: "Снятие мышечных блоков",
        video_file: "week3_lesson2.mp4",
        thumbnail_file: "week3_lesson2.jpg",
        content_points: [
          "Что такое мышечные блоки и почему они возникают",
          "Техники глубокого расслабления мышц",
          "Дыхательные упражнения для снятия напряжения"
        ],
        important_notes: "Дыхание - ключ к расслаблению. Следите за ритмом дыхания во время выполнения всех упражнений.",
        additional_info: "Регулярная практика поможет вам научиться быстро снимать напряжение в любой ситуации."
      },
      "week4_lesson1": {
        title: "Интеграция движений",
        video_file: "week4_lesson1.mp4",
        thumbnail_file: "week4_lesson1.jpg",
        content_points: [
          "Соединение изученных техник в единый комплекс",
          "Создание индивидуальной программы упражнений",
          "Адаптация упражнений под ваши потребности"
        ],
        important_notes: "На этом этапе важно прислушиваться к своему телу и выбирать те упражнения, которые приносят наибольшую пользу именно вам.",
        additional_info: "Создайте свой ежедневный 15-минутный комплекс из наиболее эффективных для вас упражнений."
      },
      "week4_lesson2": {
        title: "Ежедневная практика",
        video_file: "week4_lesson2.mp4",
        thumbnail_file: "week4_lesson2.jpg",
        content_points: [
          "Как встроить упражнения в повседневную жизнь",
          "Мини-комплексы для офиса и дома",
          "Поддержание результатов и дальнейшее развитие"
        ],
        important_notes: "Регулярность важнее интенсивности. Лучше заниматься по 10 минут каждый день, чем час раз в неделю.",
        additional_info: "Поздравляем с завершением курса! Продолжайте практику, и ваше тело скажет вам спасибо."
      }
    }
  }
};

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\api.js
// handlers/api.js
import { createCorsResponse } from '../utils/cors.js';
import { COURSE_DATA } from '../config/courses.js';
import { API_VERSION } from '../config/constants.js';

export async function handleApiDocumentation(request, env, ctx) {
  const url = new URL(request.url);
  
  return createCorsResponse(
    JSON.stringify({
      status: 'success',
      message: 'MasterMarat API для курса "Механика здоровья"',
      version: API_VERSION,
      worker_url: url.origin,
      r2_connected: env.R2 ? 'Yes' : 'No',
      endpoints: {
        'GET /': 'Документация API',
        'GET /test': 'Тестовая страница с токенами',
        'GET /player/{courseId}/{lessonId}?token=XXX': 'Плеер для обучения',
        'GET /archive/{courseId}?token=XXX': 'Плеер-архив с навигацией',
        'GET /thumbnails/{courseId}/{filename}': 'Публичные превью',
        'GET /video/{courseId}/{filename}?token=XXX': 'Защищенные видео',
        'POST /webhook/purchase': 'SendPulse webhook'
      },
      test_links: {
        test_page: `${url.origin}/test`,
        player_learning: `${url.origin}/player/course1/week1_lesson1?token=superuser_mastermarat_2025`,
        player_archive: `${url.origin}/archive/course1?token=superuser_mastermarat_2025`,
        thumbnail: `${url.origin}/thumbnails/course1/week1_lesson1.jpg`,
        video: `${url.origin}/video/course1/week1_lesson1.mp4?token=superuser_mastermarat_2025`
      },
      courses: COURSE_DATA,
      timestamp: new Date().toISOString()
    }, null, 2),
    {
      headers: {
        'Content-Type': 'application/json;charset=UTF-8',
        'Cache-Control': 'no-cache'
      }
    }
  );
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\player-archive.js
// handlers/player-archive.js
import { createCorsResponse, createUnauthorizedResponse, createNotFoundResponse } from '../utils/errors.js';
import { validateTokenFormat, hasAccess } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handlePlayerArchive(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/').filter(p => p);
  
  const courseId = pathParts[1] || 'course1';
  const token = url.searchParams.get('token') || 'demo-token-123';
  
  // Проверяем доступ к архиву
  const accessCheck = hasAccess(token, courseId, 'archive');
  if (!accessCheck.allowed) {
    return createUnauthorizedResponse(accessCheck.reason);
  }
  
  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }
  
  // Генерируем список всех уроков для навигации
  const lessonItems = [];
  for (const [lessonId, lesson] of Object.entries(course.lessons)) {
    const weekMatch = lessonId.match(/week(\d+)_lesson(\d+)/);
    const weekNum = weekMatch ? parseInt(weekMatch[1]) : 1;
    const lessonNum = weekMatch ? parseInt(weekMatch[2]) : 1;
    
    lessonItems.push(`
      <div class="lesson-card">
        <a href="${url.origin}/player/${courseId}/${lessonId}?token=${token}">
          <div class="lesson-thumbnail">
            <img src="${url.origin}/thumbnails/${courseId}/${lesson.thumbnail_file}" alt="${lesson.title}">
            <div class="play-overlay">
              <svg class="play-icon" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" fill="white"/>
              </svg>
            </div>
          </div>
          <div class="lesson-info">
            <div class="lesson-meta">
              <span class="week-badge">Неделя ${weekNum}</span>
              <span class="lesson-number">Урок ${lessonNum}</span>
            </div>
            <h3>${lesson.title}</h3>
          </div>
        </a>
      </div>
    `);
  }
  
  const archiveHTML = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Архив курса: ${course.title} - MasterMarat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #3D968C 0%, #2a6b64 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #3D968C;
            border-radius: 2px;
        }
        
        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }
        
        .lesson-card {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #2a2a2a;
        }
        
        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(61, 150, 140, 0.3);
            border-color: #3D968C;
        }
        
        .lesson-card a {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .lesson-thumbnail {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 aspect ratio */
            background: #000;
            overflow: hidden;
        }
        
        .lesson-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .lesson-card:hover .lesson-thumbnail img {
            transform: scale(1.05);
        }
        
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lesson-card:hover .play-overlay {
            opacity: 1;
        }
        
        .play-icon {
            width: 60px;
            height: 60px;
            background: rgba(61, 150, 140, 0.9);
            border-radius: 50%;
            padding: 15px;
            padding-left: 20px;
        }
        
        .lesson-info {
            padding: 20px;
        }
        
        .lesson-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .week-badge {
            background: #3D968C;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .lesson-number {
            color: #666;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        
        .lesson-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
            color: #fff;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .lessons-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        /* Анимация появления */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .lesson-card {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }
        
        .lesson-card:nth-child(1) { animation-delay: 0.1s; }
        .lesson-card:nth-child(2) { animation-delay: 0.2s; }
        .lesson-card:nth-child(3) { animation-delay: 0.3s; }
        .lesson-card:nth-child(4) { animation-delay: 0.4s; }
        .lesson-card:nth-child(5) { animation-delay: 0.5s; }
        .lesson-card:nth-child(6) { animation-delay: 0.6s; }
        .lesson-card:nth-child(7) { animation-delay: 0.7s; }
        .lesson-card:nth-child(8) { animation-delay: 0.8s; }
    </style>
</head>
<body>
    <div class="header">
        <h1> Архив курса</h1>
        <p>${course.title}</p>
    </div>
    
    <div class="container">
        <h2 class="section-title">Все уроки курса (${Object.keys(course.lessons).length})</h2>
        <div class="lessons-grid">
            ${lessonItems.join('')}
        </div>
    </div>

    <script>
        console.log('Archive mode loaded for course: ${courseId}');
        
        // Предзагрузка изображений при наведении
        document.querySelectorAll('.lesson-card').forEach(card => {
            card.addEventListener('mouseenter', () => {
                const link = card.querySelector('a');
                if (link) {
                    const preload = document.createElement('link');
                    preload.rel = 'prefetch';
                    preload.href = link.href;
                    document.head.appendChild(preload);
                }
            });
        });
    </script>
</body>
</html>`;
  
  return createCorsResponse(archiveHTML, {
    headers: {
      'Content-Type': 'text/html;charset=UTF-8',
      'Cache-Control': 'no-cache'
    }
  });
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\player-learning.js
// handlers/player-learning.js
import { createCorsResponse, createUnauthorizedResponse, createNotFoundResponse } from '../utils/errors.js';
import { validateTokenFormat, hasAccess } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handlePlayerLearning(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/').filter(p => p);
  
  if (pathParts.length < 3) {
    return createNotFoundResponse('Lesson');
  }
  
  const courseId = pathParts[1];
  const lessonId = pathParts[2];
  const token = url.searchParams.get('token') || 'demo-token-123';
  
  // Проверяем токен и доступ
  const accessCheck = hasAccess(token, courseId, 'player');
  if (!accessCheck.allowed) {
    return createUnauthorizedResponse(accessCheck.reason);
  }
  
  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }
  
  const lesson = course.lessons[lessonId];
  if (!lesson) {
    return createNotFoundResponse('Lesson');
  }
  
  // Получаем номер недели и урока
  const weekMatch = lessonId.match(/week(\d+)_lesson(\d+)/);
  const weekNum = weekMatch ? parseInt(weekMatch[1]) : 1;
  const lessonNum = weekMatch ? parseInt(weekMatch[2]) : 1;
  
  // Генерируем HTML плеера в стиле MasterMarat
  const playerHTML = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${lesson.title} - MasterMarat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* Шапка в стиле MasterMarat */
        .header {
            background: #3D968C;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .course-meta {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Контейнер видео */
        .video-section {
            background: #000;
            padding: 40px 0;
        }
        
        .video-container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }
        
        video {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
        }
        
        /* Контент под видео */
        .content-section {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .lesson-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        /* Блок "В этом видео" */
        .video-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .video-content h2 {
            color: #3D968C;
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-content ul {
            list-style: none;
            padding: 0;
        }
        
        .video-content li {
            padding: 12px 0;
            padding-left: 30px;
            position: relative;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .video-content li:last-child {
            border-bottom: none;
        }
        
        .video-content li::before {
            content: "";
            position: absolute;
            left: 0;
            color: #3D968C;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Важные моменты */
        .important-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .important-box h3 {
            color: #856404;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .important-box p {
            color: #856404;
            line-height: 1.8;
        }
        
        /* Дополнительные материалы */
        .materials-box {
            background: #e8f5f3;
            border: 1px solid #3D968C;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .materials-box h3 {
            color: #2a6b64;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .materials-box p {
            color: #555;
            line-height: 1.8;
        }
        
        /* Индикатор загрузки */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #3D968C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .video-section {
                padding: 20px 0;
            }
            
            .content-section {
                padding: 20px 15px;
            }
            
            .lesson-title {
                font-size: 1.5rem;
            }
            
            .video-content {
                padding: 20px;
            }
            
            .video-content h2 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>MasterMarat</h1>
            <div class="course-meta">
                Курс: ${course.title}  Неделя ${weekNum}, Урок ${lessonNum}
            </div>
        </div>
    </div>
    
    <div class="video-section">
        <div class="video-container">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>
            
            <video 
                controls 
                preload="metadata"
                poster="${url.origin}/thumbnails/${courseId}/${lesson.thumbnail_file}"
                id="lessonVideo"
                playsinline
            >
                <source src="${url.origin}/video/${courseId}/${lesson.video_file}?token=${token}" type="video/mp4">
                Ваш браузер не поддерживает HTML5 видео.
            </video>
        </div>
    </div>
    
    <div class="content-section">
        <h1 class="lesson-title">${lesson.title}</h1>
        
        <div class="video-content">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#3D968C">
                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                </svg>
                В этом видео:
            </h2>
            <ul>
                ${lesson.content_points ? lesson.content_points.map(point => 
                    `<li>${point}</li>`
                ).join('') : `
                <li>Ключевой момент 1: Что будет рассмотрено в этом видео</li>
                <li>Ключевой момент 2: Основные концепции или демонстрации</li>
                <li>Ключевой момент 3: Практические советы или примеры</li>
                `}
            </ul>
        </div>
        
        <div class="important-box">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#856404">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                Важные моменты
            </h3>
            <p>
                ${lesson.important_notes || 
                'Выполняйте упражнения медленно и осознанно. При появлении боли или дискомфорта остановитесь и проконсультируйтесь со специалистом.'}
            </p>
        </div>
        
        <div class="materials-box">
            <h3> Дополнительные материалы</h3>
            <p>
                ${lesson.additional_info || 
                'Рекомендуем выполнять упражнения 2-3 раза в неделю для достижения наилучших результатов. Следите за правильной техникой выполнения.'}
            </p>
        </div>
    </div>

    <script>
        const video = document.getElementById('lessonVideo');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Скрываем загрузку когда видео готово
        video.addEventListener('loadeddata', () => {
            loadingOverlay.classList.add('hidden');
            console.log('Video loaded:', '${courseId}/${lessonId}');
        });
        
        // Показываем загрузку при буферизации
        video.addEventListener('waiting', () => {
            loadingOverlay.classList.remove('hidden');
        });
        
        video.addEventListener('playing', () => {
            loadingOverlay.classList.add('hidden');
        });
        
        // Обработка ошибок
        video.addEventListener('error', (e) => {
            console.error('Video error:', e);
            loadingOverlay.classList.add('hidden');
            alert('Ошибка загрузки видео. Проверьте подключение к интернету.');
        });
        
        // Сохраняем прогресс просмотра
        let lastSaveTime = 0;
        video.addEventListener('timeupdate', () => {
            const currentTime = Math.floor(video.currentTime);
            if (currentTime - lastSaveTime > 10) { // Сохраняем каждые 10 секунд
                lastSaveTime = currentTime;
                console.log('Progress saved:', currentTime);
                // TODO: Отправить прогресс в SendPulse
            }
        });
    </script>
</body>
</html>`;
  
  return createCorsResponse(playerHTML, {
    headers: {
      'Content-Type': 'text/html;charset=UTF-8',
      'Cache-Control': 'no-cache'
    }
  });
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\test.js
// handlers/test.js
import { createCorsResponse } from '../utils/cors.js';
import { TEST_TOKENS } from '../config/constants.js';
import { hasAccess } from '../utils/token.js';

export async function handleTestPage(request, env, ctx) {
  const testResults = {};
  
  // Тестируем все токены
  for (const [name, token] of Object.entries(TEST_TOKENS)) {
    testResults[name] = {
      token,
      course1_player: hasAccess(token, 'course1', 'player'),
      course1_archive: hasAccess(token, 'course1', 'archive'),
      course2_access: hasAccess(token, 'course2', 'player'),
      admin_access: hasAccess(token, 'course1', 'admin')
    };
  }
  
  const html = `<!DOCTYPE html>
<html>
<head>
    <title>Token Test Page - MasterMarat</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .token-box { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .allowed { color: green; }
        .denied { color: red; }
        .token { 
            background: #f0f0f0; 
            padding: 4px 8px; 
            border-radius: 4px;
            font-size: 12px;
        }
        h1 { color: #3D968C; }
    </style>
</head>
<body>
    <h1> MasterMarat Token Testing</h1>
    <p>Используйте эти токены для тестирования разных уровней доступа:</p>
    
    <div class="token-box">
        <h3> Test Links</h3>
        <p><a href="/player/course1/week1_lesson1?token=superuser_mastermarat_2025">SuperUser Player</a></p>
        <p><a href="/archive/course1?token=superuser_mastermarat_2025">SuperUser Archive</a></p>
        <p><a href="/player/course1/week1_lesson1?token=demo123">Demo Player</a></p>
        <p><a href="/player/course1/week1_lesson1?token=expired_test_token">Expired Token Test</a></p>
    </div>
</body>
</html>`;
  
  return createCorsResponse(html, {
    headers: { 'Content-Type': 'text/html;charset=UTF-8' }
  });
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\thumbnails.js
// handlers/thumbnails.js
import { createCorsResponse, createNotFoundResponse } from '../utils/errors.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handleThumbnails(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/').filter(p => p);
  
  if (pathParts.length < 3) {
    return createNotFoundResponse('Thumbnail');
  }
  
  const courseId = pathParts[1];
  const fileName = pathParts[2];
  
  // Для обратной совместимости: проверяем есть ли такой урок
  let thumbnailKey = content//;
  
  // Если запрашивается по lessonId, конвертируем в имя файла
  const course = COURSE_DATA[courseId];
  if (course && course.lessons) {
    const lessonId = fileName.replace('.jpg', '').replace('.png', '');
    const lessonData = course.lessons[lessonId];
    
    if (lessonData && lessonData.thumbnail_file) {
      thumbnailKey = content//;
    }
  }
  
  try {
    const thumbnail = await env.R2.get(thumbnailKey);
    
    if (!thumbnail) {
      return createNotFoundResponse('Thumbnail');
    }
    
    const headers = new Headers();
    headers.set('Content-Type', thumbnail.httpMetadata?.contentType || 'image/jpeg');
    headers.set('Cache-Control', 'public, max-age=3600');
    headers.set('Access-Control-Allow-Origin', '*');
    
    return new Response(thumbnail.body, { headers });
  } catch (error) {
    console.error('Thumbnail error:', error);
    return createNotFoundResponse('Thumbnail');
  }
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\video.js
// handlers/video.js
import { createCorsResponse, createUnauthorizedResponse, createNotFoundResponse } from '../utils/errors.js';
import { validateTokenFormat, hasAccess } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handleVideo(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/').filter(p => p);
  
  if (pathParts.length < 3) {
    return createNotFoundResponse('Video');
  }
  
  const courseId = pathParts[1];
  const fileName = pathParts[2];
  const token = url.searchParams.get('token');
  
  // Проверяем токен
  if (!token || !validateTokenFormat(token)) {
    return createUnauthorizedResponse('Invalid or missing token');
  }
  
  // Проверяем доступ
  const accessCheck = hasAccess(token, courseId, 'player');
  if (!accessCheck.allowed) {
    return createUnauthorizedResponse(accessCheck.reason);
  }
  
  // Получаем путь к видео
  let videoKey = `content/${courseId}/${fileName}`;
  
  // Если запрашивается по lessonId, конвертируем в имя файла
  const course = COURSE_DATA[courseId];
  if (course && course.lessons) {
    const lessonId = fileName.replace('.mp4', '');
    const lessonData = course.lessons[lessonId];
    
    if (lessonData && lessonData.video_file) {
      videoKey = `content/${courseId}/${lessonData.video_file}`;
    }
  }
  
  try {
    const range = request.headers.get('range');
    
    if (range) {
      // Поддержка HTTP Range requests для видео
      const matches = range.match(/bytes=(\d+)-(\d*)/);
      if (matches) {
        const start = parseInt(matches[1], 10);
        const end = matches[2] ? parseInt(matches[2], 10) : undefined;
        
        const video = await env.R2.get(videoKey, {
          range: { offset: start, length: end ? end - start + 1 : undefined }
        });
        
        if (!video) {
          return createNotFoundResponse('Video');
        }
        
        const videoSize = video.size || 0;
        const contentLength = end ? end - start + 1 : videoSize - start;
        const contentRange = `bytes ${start}-${end || videoSize - 1}/${videoSize}`;
        
        const headers = new Headers();
        headers.set('Content-Type', video.httpMetadata?.contentType || 'video/mp4');
        headers.set('Accept-Ranges', 'bytes');
        headers.set('Content-Range', contentRange);
        headers.set('Content-Length', contentLength.toString());
        headers.set('Cache-Control', 'private, max-age=3600');
        headers.set('Access-Control-Allow-Origin', '*');
        
        return new Response(video.body, {
          status: 206,
          headers
        });
      }
    }
    
    // Обычный запрос без range
    const video = await env.R2.get(videoKey);
    
    if (!video) {
      return createNotFoundResponse('Video');
    }
    
    const headers = new Headers();
    headers.set('Content-Type', video.httpMetadata?.contentType || 'video/mp4');
    headers.set('Content-Length', video.size.toString());
    headers.set('Accept-Ranges', 'bytes');
    headers.set('Cache-Control', 'private, max-age=3600');
    headers.set('Access-Control-Allow-Origin', '*');
    
    return new Response(video.body, { headers });
    
  } catch (error) {
    console.error('Video streaming error:', error);
    return createNotFoundResponse('Video');
  }
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\handlers\webhooks.js
// handlers/webhooks.js
import { createCorsResponse } from '../utils/cors.js';
import { createBadRequestResponse } from '../utils/errors.js';
import { generateSimpleToken } from '../utils/token.js';

export async function handleWebhooks(request, env, ctx) {
  try {
    const webhook = await request.json();

    // Генерируем токен для пользователя
    const userToken = generateSimpleToken(
      webhook.email || 'test@example.com',
      webhook.course_id || 'course1'
    );

    // TODO: Обновить контакт в SendPulse через API
    // await updateSendPulseContact(webhook.email, {
    //   access_token: userToken,
    //   purchase_date: new Date().toISOString(),
    //   subscription_type: webhook.subscription_type
    // });

    return createCorsResponse(
      JSON.stringify({
        status: 'success',
        message: 'Webhook processed successfully',
        user_token: userToken,
        received_data: webhook,
        note: 'Token will be sent in first course email'
      }),
      {
        headers: { 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('Webhook processing error:', error);
    return createBadRequestResponse('Invalid webhook data');
  }
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\services\auth.js
// services/auth.js
import { validateTokenFormat, parseTokenInfo } from '../utils/token.js';

export async function checkTokenAccess(token, courseId, lessonId) {
  if (!validateTokenFormat(token)) {
    return { valid: false, reason: 'Invalid token format' };
  }

  const tokenInfo = parseTokenInfo(token);
  
  // TODO: Проверка через SendPulse API
  // Пока простая проверка для демо
  if (token === 'demo123' || token === 'demo-token-123') {
    return { valid: true, demo: true };
  }

  // Проверяем что токен для правильного курса
  if (tokenInfo.courseId && tokenInfo.courseId !== courseId) {
    return { valid: false, reason: 'Token for different course' };
  }

  return { valid: true };
}

export async function getUserFromToken(token) {
  const tokenInfo = parseTokenInfo(token);
  
  // TODO: Получить email из SendPulse по хешу
  return {
    email: 'user@example.com',
    subscription: 'standard',
    courses: ['course1']
  };
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\services\content.js
// services/content.js
import { COURSE_DATA } from '../config/courses.js';

export async function getVideoStream(env, courseId, fileName, range) {
  const videoKey = content//;
  
  if (range) {
    const matches = range.match(/bytes=(\d+)-(\d*)/);
    if (matches) {
      const start = parseInt(matches[1], 10);
      const end = matches[2] ? parseInt(matches[2], 10) : undefined;
      
      return await env.R2.get(videoKey, {
        range: { offset: start, length: end ? end - start + 1 : undefined }
      });
    }
  }
  
  return await env.R2.get(videoKey);
}

export async function getThumbnail(env, courseId, fileName) {
  const thumbnailKey = content//;
  return await env.R2.get(thumbnailKey);
}

export async function getLessonData(courseId, lessonId) {
  const course = COURSE_DATA[courseId];
  if (!course) return null;
  
  const lesson = course.lessons[lessonId];
  if (!lesson) return null;
  
  return {
    ...lesson,
    courseId,
    lessonId,
    courseTitle: course.title
  };
}

export async function getCourseStructure(courseId) {
  const course = COURSE_DATA[courseId];
  if (!course) return null;
  
  // Группируем уроки по неделям
  const weeks = {};
  Object.entries(course.lessons).forEach(([lessonId, lesson]) => {
    const weekMatch = lessonId.match(/week(\d+)/);
    const weekNum = weekMatch ? parseInt(weekMatch[1]) : 1;
    
    if (!weeks[weekNum]) {
      weeks[weekNum] = [];
    }
    
    weeks[weekNum].push({
      id: lessonId,
      ...lesson
    });
  });
  
  return {
    title: course.title,
    weeks,
    totalLessons: Object.keys(course.lessons).length
  };
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\services\sendpulse.js
// services/sendpulse.js
const SENDPULSE_API_URL = 'https://api.sendpulse.com';

export async function verifyPurchaseToken(token) {
  // TODO: Реальная проверка через SendPulse API
  console.log('Verifying token with SendPulse:', token);
  
  return {
    valid: true,
    email: 'user@example.com',
    subscription_type: 'standard'
  };
}

export async function updateUserProgress(email, courseId, lessonId) {
  // TODO: Обновить прогресс в SendPulse
  console.log(Updating progress for : /);
  
  return { success: true };
}

export async function getUserSubscription(email) {
  // TODO: Получить данные подписки из SendPulse
  return {
    email,
    active: true,
    type: 'standard',
    expires: '2025-12-31',
    courses: ['course1']
  };
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\templates\base.js
// templates/base.js
export function createHtmlPage(title, content, scripts = '') {
  return <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> - MasterMarat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .header {
            background: #3D968C;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .video-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    
    
</body>
</html>;
}

export function createVideoPlayer(videoUrl, posterUrl) {
  return 
    <div class="video-container">
        <video 
            controls 
            preload="metadata"
            poster=""
            id="lesson-video"
        >
            <source src="" type="video/mp4">
            Ваш браузер не поддерживает видео.
        </video>
    </div>
  ;
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\utils\cors.js
// utils/cors.js
export const CORS_HEADERS = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Range',
  'Access-Control-Expose-Headers': 'Content-Length, Content-Range'
};

export function addCorsHeaders(response) {
  const headers = new Headers(response.headers);
  Object.entries(CORS_HEADERS).forEach(([key, value]) => {
    headers.set(key, value);
  });
  
  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers
  });
}

export function createCorsResponse(body, init = {}) {
  return new Response(body, {
    ...init,
    headers: {
      ...CORS_HEADERS,
      ...init.headers
    }
  });
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\utils\errors.js
// utils/errors.js
import { CORS_HEADERS } from './cors.js';

export function createErrorResponse(message, status = 400, details = null) {
  const body = {
    status: 'error',
    message,
    ...(details && { details })
  };
  
  return new Response(JSON.stringify(body, null, 2), {
    status,
    headers: {
      ...CORS_HEADERS,
      'Content-Type': 'application/json;charset=UTF-8'
    }
  });
}

export function createNotFoundResponse(resource) {
  return createErrorResponse(`${resource} not found`, 404);
}

export function createUnauthorizedResponse(reason = 'Unauthorized') {
  return createErrorResponse(reason, 401);
}

export { createCorsResponse } from './cors.js';
export function createBadRequestResponse(message, details = null) {
  return createErrorResponse(message, 400, details);
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\utils\token.js
// utils/token.js
import { TEST_TOKENS, TOKEN_PERMISSIONS } from '../config/constants.js';

export function generateToken(email, courseId = null) {
  const timestamp = Date.now().toString(36);
  const emailHash = btoa(email).replace(/=/g, '').substring(0, 8);
  const coursePrefix = courseId ? `${courseId}_` : '';
  return `${emailHash}_${coursePrefix}${timestamp}`;
}

export function validateTokenFormat(token) {
  // РџСЂРѕРІРµСЂСЏРµРј С‚РµСЃС‚РѕРІС‹Рµ С‚РѕРєРµРЅС‹
  if (Object.values(TEST_TOKENS).includes(token)) {
    return true;
  }
  
  // РџСЂРѕРІРµСЂСЏРµРј С„РѕСЂРјР°С‚ РѕР±С‹С‡РЅС‹С… С‚РѕРєРµРЅРѕРІ
  return token && token.length >= 3 && token.includes('_');
}

export function parseTokenInfo(token) {
  // Р”Р»СЏ С‚РµСЃС‚РѕРІС‹С… С‚РѕРєРµРЅРѕРІ РІРѕР·РІСЂР°С‰Р°РµРј РёС… РїСЂР°РІР°
  if (TOKEN_PERMISSIONS[token]) {
    return {
      isTestToken: true,
      permissions: TOKEN_PERMISSIONS[token],
      token
    };
  }
  
  // Р”Р»СЏ РѕР±С‹С‡РЅС‹С… С‚РѕРєРµРЅРѕРІ РїР°СЂСЃРёРј СЃС‚СЂСѓРєС‚СѓСЂСѓ
  const parts = token.split('_');
  return {
    isTestToken: false,
    emailHash: parts[0],
    courseId: parts.length > 2 ? parts[1] : null,
    timestamp: parts[parts.length - 1]
  };
}

export function hasAccess(token, courseId, feature = 'player') {
  const tokenInfo = parseTokenInfo(token);
  
  // Р”Р»СЏ С‚РµСЃС‚РѕРІС‹С… С‚РѕРєРµРЅРѕРІ РїСЂРѕРІРµСЂСЏРµРј РїСЂР°РІР°
  if (tokenInfo.isTestToken) {
    const perms = tokenInfo.permissions;
    
    // РџСЂРѕРІРµСЂСЏРµРј РЅРµ РёСЃС‚РµРє Р»Рё С‚РѕРєРµРЅ
    if (new Date(perms.expires) < new Date()) {
      return { allowed: false, reason: 'Token expired' };
    }
    
    // SuperUser РёРјРµРµС‚ РґРѕСЃС‚СѓРї РєРѕ РІСЃРµРјСѓ
    if (perms.type === 'superuser') {
      return { allowed: true, permissions: perms };
    }
    
    // РџСЂРѕРІРµСЂСЏРµРј РґРѕСЃС‚СѓРї Рє РєСѓСЂСЃСѓ
    const hasCourseAccess = perms.courses.includes('*') || 
                           perms.courses.includes(courseId);
    
    // РџСЂРѕРІРµСЂСЏРµРј РґРѕСЃС‚СѓРї Рє С„СѓРЅРєС†РёРё
    const hasFeatureAccess = perms.features.includes(feature);
    
    if (!hasCourseAccess) {
      return { allowed: false, reason: 'No access to this course' };
    }
    
    if (!hasFeatureAccess) {
      return { allowed: false, reason: 'No access to this feature' };
    }
    
    return { allowed: true, permissions: perms };
  }
  
  // Р”Р»СЏ РѕР±С‹С‡РЅС‹С… С‚РѕРєРµРЅРѕРІ - РїСЂРѕСЃС‚Р°СЏ РїСЂРѕРІРµСЂРєР°
  // TODO: РёРЅС‚РµРіСЂР°С†РёСЏ СЃ SendPulse
  return { allowed: true, permissions: { type: 'user' } };
}
export function generateSimpleToken() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\src\worker-new.js
// worker-new.js - только роутинг
import { CORS_HEADERS } from './utils/cors.js';
import { createErrorResponse } from './utils/errors.js';

// Импортируем обработчики
import { handleApiDocumentation } from './handlers/api.js';
import { handleThumbnails } from './handlers/thumbnails.js';
import { handleVideo } from './handlers/video.js';
import { handlePlayerLearning } from './handlers/player-learning.js';
import { handlePlayerArchive } from './handlers/player-archive.js';
import { handleWebhooks } from './handlers/webhooks.js';
import { handleTestPage } from './handlers/test.js';

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: CORS_HEADERS });
    }

    try {
      // Роутинг запросов
      if (url.pathname === '/') {
        return await handleApiDocumentation(request, env, ctx);
      }

      // НОВЫЙ: Тестовая страница
      if (url.pathname === '/test') {
        return await handleTestPage(request, env, ctx);
      }

      if (url.pathname.startsWith('/thumbnails/')) {
        return await handleThumbnails(request, env, ctx);
      }

      if (url.pathname.startsWith('/video/')) {
        return await handleVideo(request, env, ctx);
      }

      if (url.pathname.startsWith('/player/')) {
        return await handlePlayerLearning(request, env, ctx);
      }

      if (url.pathname.startsWith('/archive/')) {
        return await handlePlayerArchive(request, env, ctx);
      }

      if (url.pathname === '/webhook/purchase' && request.method === 'POST') {
        return await handleWebhooks(request, env, ctx);
      }

      // 404 для неизвестных маршрутов
      return createErrorResponse('Endpoint not found', 404, {
        path: url.pathname,
        method: request.method
      });

    } catch (error) {
      console.error('Worker error:', error);
      return createErrorResponse(
        'Internal server error',
        500,
        { message: error.message }
      );
    }
  }
};

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\package.json
{
    "name":  "mastermarat-api",
    "version":  "1.0.0",
    "description":  "MasterMarat API Worker for protected video delivery",
    "main":  "src/worker-new.js",
    "scripts":  {
                    "dev":  "wrangler dev",
                    "dev:remote":  "wrangler dev --env dev --remote",
                    "test":  "node ../../scripts/test-api.js",
                    "lint":  "eslint src/",
                    "format":  "prettier --write src/**/*.js",
                    "deploy:dev":  "wrangler deploy --env dev",
                    "logs:dev":  "wrangler tail --env dev",
                    "deploy":  "wrangler deploy",
                    "logs":  "wrangler tail",
                    "login":  "wrangler login",
                    "whoami":  "wrangler whoami"
                },
    "keywords":  [
                     "cloudflare",
                     "workers",
                     "edtech",
                     "api",
                     "video-streaming",
                     "mastermarat",
                     "r2-storage",
                     "osteopathy",
                     "health-education"
                 ],
    "author":  "MasterMarat Team",
    "license":  "MIT",
    "repository":  {
                       "type":  "git",
                       "url":  "https://github.com/Shivalino/mastermarat-project.git"
                   },
    "homepage":  "https://mastermarat.com",
    "devDependencies":  {
                            "eslint":  "^8.57.1",
                            "prettier":  "^3.6.2",
                            "wrangler":  "^4.22.0"
                        },
    "engines":  {
                    "node":  "\u003e=18.0.0",
                    "npm":  "\u003e=8.0.0"
                }
}

//C:\Projects\mastermaratcom\mastermarat-project\workers\api\wrangler.toml
name = "mastermarat-api"
main = "src/worker-new.js"
compatibility_date = "2024-07-01"

# R2 bucket binding
[[r2_buckets]]
binding = "R2"
bucket_name = "mastermarat-videos"

# Production environment
[env.production]
name = "mastermarat-api"
route = { pattern = "api.mastermarat.com/*", zone_name = "mastermarat.com" }

[env.production.vars]
ENVIRONMENT = "production"

# Development environment
[env.dev]
name = "mastermarat-api-dev"
route = { pattern = "api-dev.mastermarat.com/*", zone_name = "mastermarat.com" }

[env.dev.vars]
ENVIRONMENT = "development"

//C:\Projects\mastermaratcom\mastermarat-project\.eslintrc.js
module.exports = {
  env: {
    browser: true,
    es2022: true,
    node: true,
    worker: true
  },
  extends: [
    'eslint:recommended'
  ],
  parserOptions: {
    ecmaVersion: 'latest',
    sourceType: 'module'
  },
  globals: {
    // Cloudflare Workers globals
    'addEventListener': 'readonly',
    'Response': 'readonly',
    'Request': 'readonly',
    'URL': 'readonly',
    'URLSearchParams': 'readonly',
    'Headers': 'readonly',
    'FormData': 'readonly',
    'btoa': 'readonly',
    'atob': 'readonly',
    'crypto': 'readonly',
    'caches': 'readonly',
    'fetch': 'readonly'
  },
  rules: {
    // Code quality
    'no-unused-vars': ['error', { 'argsIgnorePattern': '^_' }],
    'no-console': 'off', // Разрешаем console.log в Workers
    'prefer-const': 'error',
    'no-var': 'error',
    
    // Code style
    'indent': ['error', 2],
    'quotes': ['error', 'single', { 'avoidEscape': true }],
    'semi': ['error', 'always'],
    'comma-dangle': ['error', 'never'],
    'object-curly-spacing': ['error', 'always'],
    'array-bracket-spacing': ['error', 'never'],
    
    // Best practices
    'eqeqeq': ['error', 'always'],
    'curly': ['error', 'all'],
    'dot-notation': 'error',
    'no-trailing-spaces': 'error',
    'no-multiple-empty-lines': ['error', { 'max': 2 }],
    'eol-last': ['error', 'always'],
    
    // Security
    'no-eval': 'error',
    'no-implied-eval': 'error',
    'no-script-url': 'error'
  },
  overrides: [
    {
      // Специальные правила для Cloudflare Workers
      files: ['src/worker.js'],
      rules: {
        'no-undef': 'off' // Отключаем для Workers globals
      }
    },
    {
      // Правила для тестов
      files: ['scripts/test-*.js', '**/*.test.js'],
      rules: {
        'no-console': 'off'
      }
    }
  ]
};

//C:\Projects\mastermaratcom\mastermarat-project\.gitignore
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Environment variables
.env
.env.local
.env.production
.env.*.local
.dev.vars

# Cloudflare
.wrangler/
.miniflare/
wrangler.toml.backup

# Build outputs
dist/
build/
.cache/
.parcel-cache/

# OS files
.DS_Store
Thumbs.db
desktop.ini
*.swp
*.swo
*~

# IDE
.vscode/
.idea/
*.sublime-project
*.sublime-workspace

# Testing
coverage/
.nyc_output/

# Temporary files
*.tmp
*.temp
*.bak
*.backup
*.old
tmp/
temp_upload/

# Logs
logs/
*.log

# Security
*.pem
*.key
*.cert
*.crt
private/
secrets/

# Media files (use R2 storage instead)
*.mp4
*.mov
*.avi
*.mkv
*.webm

# Databases
*.sqlite
*.sqlite3
*.db

# Project specific
/content/videos/
/content/thumbnails/
analytics-data/
user-data/re -Encoding UTF8 -NoNewline

Write-Host "✅ .gitignore создан!" -ForegroundColor Green

//C:\Projects\mastermaratcom\mastermarat-project\.prettierrc
{
  "semi": true,
  "trailingComma": "none",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false,
  "endOfLine": "crlf",
  "bracketSpacing": true,
  "arrowParens": "avoid",
  "overrides": [
    {
      "files": "*.md",
      "options": {
        "printWidth": 70,
        "proseWrap": "always"
      }
    },
    {
      "files": "*.json",
      "options": {
        "trailingComma": "none"
      }
    }
  ]
}

//C:\Projects\mastermaratcom\mastermarat-project\eslint.config.js
// eslint.config.js - ESLint v9 configuration
import js from '@eslint/js';

export default [
  js.configs.recommended,
  {
    files: ['workers/**/*.js', 'scripts/**/*.js'],
    languageOptions: {
      ecmaVersion: 2022,
      sourceType: 'module',
      globals: {
        // Cloudflare Workers globals
        'addEventListener': 'readonly',
        'Response': 'readonly',
        'Request': 'readonly',
        'URL': 'readonly',
        'URLSearchParams': 'readonly',
        'Headers': 'readonly',
        'FormData': 'readonly',
        'btoa': 'readonly',
        'atob': 'readonly',
        'crypto': 'readonly',
        'caches': 'readonly',
        'fetch': 'readonly',
        'console': 'readonly',
        'Date': 'readonly',
        'JSON': 'readonly',
        'parseInt': 'readonly',
        'process': 'readonly'
      }
    },
    rules: {
      // Code quality
      'no-unused-vars': ['error', { 'argsIgnorePattern': '^_' }],
      'no-console': 'off', // Разрешаем console.log в Workers
      'prefer-const': 'error',
      'no-var': 'error',
      
      // Code style
      'indent': ['error', 2],
      'quotes': ['error', 'single', { 'avoidEscape': true }],
      'semi': ['error', 'always'],
      'comma-dangle': ['error', 'never'],
      'object-curly-spacing': ['error', 'always'],
      'array-bracket-spacing': ['error', 'never'],
      
      // Best practices
      'eqeqeq': ['error', 'always'],
      'curly': ['error', 'all'],
      'dot-notation': 'error',
      'no-trailing-spaces': 'error',
      'no-multiple-empty-lines': ['error', { 'max': 2 }],
      'eol-last': ['error', 'always'],
      
      // Security
      'no-eval': 'error',
      'no-implied-eval': 'error'
    }
  },
  {
    // Специальные правила для тестов
    files: ['scripts/test-*.js', '**/*.test.js'],
    rules: {
      'no-console': 'off'
    }
  }
];

//C:\Projects\mastermaratcom\mastermarat-project\package.json
{
  "name": "mastermarat-project",
  "version": "1.0.0",
  "description": "MasterMarat EdTech Project",
  "private": true,
  "scripts": {
    "dev": "npm run dev --prefix workers/api",
    "deploy": "npm run deploy --prefix workers/api",
    "lint": "npm run lint --prefix workers/api",
    "lint:fix": "npm run lint:fix --prefix workers/api",
    "format": "npm run format --prefix workers/api",
    "format:check": "npm run format:check --prefix workers/api",
    "install:all": "npm install && cd workers/api && npm install"
  },
  "workspaces": [
    "workers/api"
  ],
  "devDependencies": {
    "prettier": "^3.0.0",
    "eslint": "^8.0.0"
  }
}
