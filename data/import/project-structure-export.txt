# export-project-structure.ps1
# –≠–∫—Å–ø–æ—Ä—Ç –∑–Ω–∞—á–∏–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ MasterMarat

param(
    [string]$OutputFormat = "tree",  # tree, markdown, json
    [string]$OutputFile = "",
    [switch]$ShowContent = $false,
    [switch]$IncludeGitInfo = $false
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: —á—Ç–æ –≤–∫–ª—é—á–∞—Ç—å –≤ —ç–∫—Å–ø–æ—Ä—Ç
$includePatterns = @(
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    "*.json",
    "*.toml",
    "*.yml",
    "*.yaml",
    ".gitignore",
    ".gitattributes",
    ".env.example",
    
    # –ö–æ–¥
    "*.js",
    "*.ps1",
    "*.sh",
    "*.bat",
    
    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    "*.md",
    "README*",
    "LICENSE*",
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
    ".gitkeep"
)

# –ü–∞–ø–∫–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
$includeFolders = @(
    "workers",
    "scripts", 
    "docs",
    "data",
    "content",
    "temp_upload"
)

# –ß—Ç–æ –∏—Å–∫–ª—é—á–∞—Ç—å
$excludePatterns = @(
    # –°–∏—Å—Ç–µ–º–Ω—ã–µ
    ".git",
    ".wrangler",
    "node_modules",
    ".vscode",
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ
    "*.log",
    "*.tmp",
    "*.temp",
    "*.bak",
    "*.backup",
    
    # –ú–µ–¥–∏–∞ (–±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã)
    "*.mp4",
    "*.mov",
    "*.avi",
    "*.jpg",
    "*.jpeg",
    "*.png",
    "*.gif",
    
    # –î–∞–Ω–Ω—ã–µ
    "*.db",
    "*.sqlite",
    
    # –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ
    ".env",
    ".dev.vars",
    "*.pem",
    "*.key",
    
    # –ö–µ—à
    "dist",
    "build",
    ".cache"
)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
function Get-ProjectStructure {
    param([string]$Path = ".")
    
    $items = @()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏
    Get-ChildItem -Path $Path -Recurse | ForEach-Object {
        $relativePath = $_.FullName.Substring((Get-Location).Path.Length + 1)
        $include = $false
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        foreach ($pattern in $excludePatterns) {
            if ($relativePath -like "*$pattern*") {
                return
            }
        }
        
        # –î–ª—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∫–ª—é—á–µ–Ω–∏—è
        if (-not $_.PSIsContainer) {
            foreach ($pattern in $includePatterns) {
                if ($_.Name -like $pattern) {
                    $include = $true
                    break
                }
            }
        } else {
            # –î–ª—è –ø–∞–ø–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥—è—Ç –ª–∏ –æ–Ω–∏ –≤ —Å–ø–∏—Å–æ–∫
            foreach ($folder in $includeFolders) {
                if ($relativePath -like "$folder*") {
                    $include = $true
                    break
                }
            }
        }
        
        if ($include) {
            $item = @{
                Path = $relativePath
                Name = $_.Name
                IsDirectory = $_.PSIsContainer
                Size = if (-not $_.PSIsContainer) { $_.Length } else { 0 }
                LastModified = $_.LastWriteTime
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º Git –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if ($IncludeGitInfo -and -not $_.PSIsContainer) {
                $gitStatus = git status --porcelain $_.FullName 2>$null
                if ($gitStatus) {
                    $item.GitStatus = $gitStatus.Substring(0, 2).Trim()
                }
            }
            
            $items += $item
        }
    }
    
    return $items | Sort-Object Path
}

# –í—ã–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–µ—Ä–µ–≤–∞
function Export-AsTree {
    param($Items)
    
    $tree = @()
    $tree += "MasterMarat Project Structure"
    $tree += "=" * 30
    $tree += ""
    
    $lastDepth = 0
    foreach ($item in $Items) {
        $parts = $item.Path.Split('\')
        $depth = $parts.Count - 1
        $indent = "  " * $depth
        $prefix = if ($item.IsDirectory) { "üìÅ" } else { "üìÑ" }
        
        $line = "$indent$prefix $($item.Name)"
        
        if (-not $item.IsDirectory -and $item.Size -gt 0) {
            $sizeKB = [math]::Round($item.Size / 1KB, 2)
            $line += " ($sizeKB KB)"
        }
        
        if ($item.GitStatus) {
            $statusIcon = switch ($item.GitStatus) {
                "M" { "‚úèÔ∏è" }
                "A" { "‚ûï" }
                "D" { "‚ûñ" }
                "??" { "‚ùì" }
                default { "üìù" }
            }
            $line += " $statusIcon"
        }
        
        $tree += $line
    }
    
    return $tree -join "`n"
}

# –í—ã–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown
function Export-AsMarkdown {
    param($Items)
    
    $md = @()
    $md += "# MasterMarat Project Structure"
    $md += ""
    $md += "Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
    $md += ""
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    $fileCount = ($Items | Where-Object { -not $_.IsDirectory }).Count
    $folderCount = ($Items | Where-Object { $_.IsDirectory }).Count
    $totalSize = ($Items | Where-Object { -not $_.IsDirectory } | Measure-Object -Property Size -Sum).Sum
    
    $md += "## Statistics"
    $md += "- Total files: $fileCount"
    $md += "- Total folders: $folderCount"
    $md += "- Total size: $([math]::Round($totalSize / 1MB, 2)) MB"
    $md += ""
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –ø–∞–ø–∫–∞–º
    $md += "## Project Structure"
    $md += ""
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–æ—Ä–Ω–µ–≤—ã–º –ø–∞–ø–∫–∞–º
    $rootFolders = $Items | ForEach-Object {
        $_.Path.Split('\')[0]
    } | Select-Object -Unique
    
    foreach ($folder in $rootFolders) {
        $md += "### üìÅ $folder/"
        $md += ""
        
        $folderItems = $Items | Where-Object { $_.Path -like "$folder*" }
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ñ–∞–π–ª–æ–≤
        $files = $folderItems | Where-Object { -not $_.IsDirectory }
        if ($files) {
            $md += "| File | Size | Modified |"
            $md += "|------|------|----------|"
            
            foreach ($file in $files) {
                $relativePath = $file.Path.Substring($folder.Length + 1)
                $sizeKB = [math]::Round($file.Size / 1KB, 2)
                $modified = $file.LastModified.ToString('yyyy-MM-dd')
                $md += "| $relativePath | $sizeKB KB | $modified |"
            }
            $md += ""
        }
    }
    
    # –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
    $md += "## Key Files"
    $md += ""
    
    $keyFiles = @(
        @{Pattern = "worker*.js"; Description = "API Workers"},
        @{Pattern = "*.ps1"; Description = "PowerShell Scripts"},
        @{Pattern = "courses*.js"; Description = "Course Configuration"},
        @{Pattern = "wrangler.toml"; Description = "Cloudflare Config"}
    )
    
    foreach ($key in $keyFiles) {
        $files = $Items | Where-Object { $_.Name -like $key.Pattern -and -not $_.IsDirectory }
        if ($files) {
            $md += "### $($key.Description)"
            foreach ($file in $files) {
                $md += "- `$($file.Path)`"
            }
            $md += ""
        }
    }
    
    return $md -join "`n"
}

# –í—ã–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
function Export-AsJson {
    param($Items)
    
    $structure = @{
        project = "MasterMarat"
        generated = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        statistics = @{
            files = ($Items | Where-Object { -not $_.IsDirectory }).Count
            folders = ($Items | Where-Object { $_.IsDirectory }).Count
            totalSizeMB = [math]::Round((($Items | Where-Object { -not $_.IsDirectory } | Measure-Object -Property Size -Sum).Sum) / 1MB, 2)
        }
        structure = @{}
    }
    
    # –°—Ç—Ä–æ–∏–º –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    foreach ($item in $Items) {
        $parts = $item.Path.Split('\')
        $current = $structure.structure
        
        for ($i = 0; $i -lt $parts.Count - 1; $i++) {
            if (-not $current.ContainsKey($parts[$i])) {
                $current[$parts[$i]] = @{}
            }
            $current = $current[$parts[$i]]
        }
        
        if (-not $item.IsDirectory) {
            $current[$parts[-1]] = @{
                size = $item.Size
                modified = $item.LastModified.ToString('yyyy-MM-dd HH:mm:ss')
            }
            if ($item.GitStatus) {
                $current[$parts[-1]].gitStatus = $item.GitStatus
            }
        }
    }
    
    return $structure | ConvertTo-Json -Depth 10
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
function Main {
    Write-Host "üîç –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ MasterMarat..." -ForegroundColor Cyan
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    $items = Get-ProjectStructure
    
    Write-Host "üìä –ù–∞–π–¥–µ–Ω–æ: $($items.Count) —ç–ª–µ–º–µ–Ω—Ç–æ–≤" -ForegroundColor Green
    
    # –≠–∫—Å–ø–æ—Ä—Ç –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    $output = switch ($OutputFormat.ToLower()) {
        "tree" { Export-AsTree -Items $items }
        "markdown" { Export-AsMarkdown -Items $items }
        "md" { Export-AsMarkdown -Items $items }
        "json" { Export-AsJson -Items $items }
        default { Export-AsTree -Items $items }
    }
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–≤–æ–¥
    if ($OutputFile) {
        $output | Out-File -FilePath $OutputFile -Encoding UTF8
        Write-Host "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: $OutputFile" -ForegroundColor Green
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å
        $open = Read-Host "–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª? (y/n)"
        if ($open -eq 'y') {
            Start-Process $OutputFile
        }
    } else {
        # –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
        Write-Host ""
        Write-Output $output
    }
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if ($ShowContent) {
        Write-Host "`nüìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:" -ForegroundColor Yellow
        
        $keyFiles = @("wrangler.toml", "package.json", ".gitignore")
        foreach ($fileName in $keyFiles) {
            $file = $items | Where-Object { $_.Name -eq $fileName } | Select-Object -First 1
            if ($file) {
                Write-Host "`n--- $($file.Path) ---" -ForegroundColor Cyan
                Get-Content $file.Path -ErrorAction SilentlyContinue | Select-Object -First 20
            }
        }
    }
}

# –ó–∞–ø—É—Å–∫
Main