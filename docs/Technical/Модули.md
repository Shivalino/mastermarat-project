# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é API –≤–æ—Ä–∫–µ—Ä–∞
cd "C:\Projects\mastermaratcom\mastermarat-project\workers\api"

# –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
New-Item -ItemType Directory -Path "src\config" -Force
New-Item -ItemType Directory -Path "src\handlers" -Force
New-Item -ItemType Directory -Path "src\services" -Force
New-Item -ItemType Directory -Path "src\templates" -Force
New-Item -ItemType Directory -Path "src\utils" -Force

Write-Host "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ —Å–æ–∑–¥–∞–Ω–∞!" -ForegroundColor Green

# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ñ–∞–π–ª—ã –º–æ–¥—É–ª–µ–π
@"
// config/courses.js
const COURSE_DATA = {
  "course1": {
    title: "–ú–µ—Ö–∞–Ω–∏–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è",
    lessons: {
      "week1_lesson1": {
        title: "–í–≤–µ–¥–µ–Ω–∏–µ –≤ –±–∏–æ–º–µ—Ö–∞–Ω–∏–∫—É —Ç–µ–ª–∞",
        video_file: "week1_lesson1.mp4",
        thumbnail_file: "week1_lesson1.jpg"
      },
      "week1_lesson2": {
        title: "–û—Å–Ω–æ–≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Å–∞–Ω–∫–∏",
        video_file: "week1_lesson2.mp4",
        thumbnail_file: "week1_lesson2.jpg"
      },
      "week2_lesson1": {
        title: "–†–∞–±–æ—Ç–∞ —Å –ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫–æ–º",
        video_file: "week2_lesson1.mp4",
        thumbnail_file: "week2_lesson1.jpg"
      },
      "week2_lesson2": {
        title: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —à–µ–∏",
        video_file: "week2_lesson2.mp4",
        thumbnail_file: "week2_lesson2.jpg"
      },
      "week3_lesson1": {
        title: "–¢–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–º–∞—Å—Å–∞–∂–∞",
        video_file: "week3_lesson1.mp4",
        thumbnail_file: "week3_lesson1.jpg"
      },
      "week3_lesson2": {
        title: "–°–Ω—è—Ç–∏–µ –º—ã—à–µ—á–Ω—ã—Ö –±–ª–æ–∫–æ–≤",
        video_file: "week3_lesson2.mp4",
        thumbnail_file: "week3_lesson2.jpg"
      },
      "week4_lesson1": {
        title: "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏–π",
        video_file: "week4_lesson1.mp4",
        thumbnail_file: "week4_lesson1.jpg"
      },
      "week4_lesson2": {
        title: "–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞",
        video_file: "week4_lesson2.mp4",
        thumbnail_file: "week4_lesson2.jpg"
      }
    }
  }
};

export { COURSE_DATA };
"@ | Out-File -FilePath "src\config\courses.js" -Encoding UTF8

@"
// config/constants.js
export const API_VERSION = '1.0.0';
export const SUPPORTED_VIDEO_FORMATS = ['mp4', 'webm'];
export const SUPPORTED_IMAGE_FORMATS = ['jpg', 'jpeg', 'png', 'webp'];

export const ENDPOINTS = {
  API_DOC: '/',
  PLAYER_LEARNING: '/player',
  PLAYER_ARCHIVE: '/archive', 
  THUMBNAILS: '/thumbnails',
  VIDEO: '/video',
  WEBHOOK: '/webhook/purchase'
};

export const ERROR_MESSAGES = {
  TOKEN_REQUIRED: 'Token required',
  TOKEN_INVALID: 'Invalid token',
  VIDEO_NOT_FOUND: 'Video not found',
  COURSE_NOT_FOUND: 'Course not found',
  LESSON_NOT_FOUND: 'Lesson not found'
};
"@ | Out-File -FilePath "src\config\constants.js" -Encoding UTF8

@"
// utils/cors.js
export const CORS_HEADERS = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Range',
  'Access-Control-Expose-Headers': 'Content-Length, Content-Range'
};

export function addCorsHeaders(response) {
  const headers = new Headers(response.headers);
  Object.entries(CORS_HEADERS).forEach(([key, value]) => {
    headers.set(key, value);
  });
  
  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers
  });
}

export function createCorsResponse(body, init = {}) {
  return new Response(body, {
    ...init,
    headers: {
      ...CORS_HEADERS,
      ...init.headers
    }
  });
}
"@ | Out-File -FilePath "src\utils\cors.js" -Encoding UTF8

@"
// utils/errors.js
import { createCorsResponse } from './cors.js';

export function createErrorResponse(error, status = 500, extra = {}) {
  return createCorsResponse(
    JSON.stringify({
      status: 'error',
      error: error,
      timestamp: new Date().toISOString(),
      ...extra
    }),
    {
      status,
      headers: { 'Content-Type': 'application/json' }
    }
  );
}

export function createNotFoundResponse(resource) {
  return createErrorResponse(
    `${resource} not found`,
    404,
    { resource }
  );
}

export function createUnauthorizedResponse(message = 'Unauthorized') {
  return createErrorResponse(message, 401);
}

export function createBadRequestResponse(message = 'Bad Request') {
  return createErrorResponse(message, 400);
}
"@ | Out-File -FilePath "src\utils\errors.js" -Encoding UTF8

@"
// utils/token.js
export function generateSimpleToken(email, courseId = null) {
  const timestamp = Date.now().toString();
  const emailHash = btoa(email)
    .replace(/[^a-zA-Z0-9]/g, '')
    .substring(0, 8);
  
  const coursePrefix = courseId ? `${courseId}_` : '';
  return `${emailHash}_${coursePrefix}${timestamp.substring(-8)}`;
}

export function validateTokenFormat(token) {
  // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞
  return token && token.length >= 3 && token.includes('_');
}

export function parseTokenInfo(token) {
  // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç–æ–∫–µ–Ω–∞
  const parts = token.split('_');
  return {
    emailHash: parts[0],
    courseId: parts.length > 2 ? parts[1] : null,
    timestamp: parts[parts.length - 1]
  };
}
"@ | Out-File -FilePath "src\utils\token.js" -Encoding UTF8

Write-Host "‚úÖ –ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏ —Å–æ–∑–¥–∞–Ω—ã!" -ForegroundColor Green

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å–Ω—ã–π worker.js
@"
// worker.js - —Ç–æ–ª—å–∫–æ —Ä–æ—É—Ç–∏–Ω–≥
import { CORS_HEADERS } from './utils/cors.js';
import { createErrorResponse } from './utils/errors.js';

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
import { handleApiDocumentation } from './handlers/api.js';
import { handleThumbnails } from './handlers/thumbnails.js';
import { handleVideo } from './handlers/video.js';
import { handlePlayerLearning } from './handlers/player-learning.js';
import { handlePlayerArchive } from './handlers/player-archive.js';
import { handleWebhooks } from './handlers/webhooks.js';

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: CORS_HEADERS });
    }

    try {
      // –†–æ—É—Ç–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤
      if (url.pathname === '/') {
        return await handleApiDocumentation(request, env, ctx);
      }

      if (url.pathname.startsWith('/thumbnails/')) {
        return await handleThumbnails(request, env, ctx);
      }

      if (url.pathname.startsWith('/video/')) {
        return await handleVideo(request, env, ctx);
      }

      if (url.pathname.startsWith('/player/')) {
        return await handlePlayerLearning(request, env, ctx);
      }

      if (url.pathname.startsWith('/archive/')) {
        return await handlePlayerArchive(request, env, ctx);
      }

      if (url.pathname === '/webhook/purchase' && request.method === 'POST') {
        return await handleWebhooks(request, env, ctx);
      }

      // 404 –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
      return createErrorResponse('Endpoint not found', 404, {
        path: url.pathname,
        method: request.method
      });

    } catch (error) {
      console.error('Worker error:', error);
      return createErrorResponse(
        'Internal server error',
        500,
        { message: error.message }
      );
    }
  }
};
"@ | Out-File -FilePath "src\worker-new.js" -Encoding UTF8

Write-Host "‚úÖ –ù–æ–≤—ã–π –º–æ–¥—É–ª—å–Ω—ã–π worker.js —Å–æ–∑–¥–∞–Ω –∫–∞–∫ worker-new.js!" -ForegroundColor Green
Write-Host "" -ForegroundColor White
Write-Host "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:" -ForegroundColor Cyan
Write-Host "1. –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ handlers/" -ForegroundColor Yellow
Write-Host "2. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤ services/" -ForegroundColor Yellow  
Write-Host "3. –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –≤ templates/" -ForegroundColor Yellow
Write-Host "4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–º–µ–Ω–∏—Ç—å worker.js" -ForegroundColor Yellow
Write-Host "" -ForegroundColor White
Write-Host "üéØ –ì–æ—Ç–æ–≤–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤!" -ForegroundColor Green