# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
cd "C:\Projects\mastermaratcom\mastermarat-project\workers\api"

# –°–æ–∑–¥–∞–µ–º handlers/api.js - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
@"
// handlers/api.js
import { createCorsResponse } from '../utils/cors.js';
import { COURSE_DATA } from '../config/courses.js';
import { API_VERSION } from '../config/constants.js';

export async function handleApiDocumentation(request, env, ctx) {
  const url = new URL(request.url);
  
  return createCorsResponse(
    JSON.stringify({
      status: 'success',
      message: 'MasterMarat API –¥–ª—è –∫—É—Ä—Å–∞ "–ú–µ—Ö–∞–Ω–∏–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è"',
      version: API_VERSION,
      worker_url: url.origin,
      r2_connected: env.R2 ? 'Yes' : 'No',
      endpoints: {
        'GET /': '–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API',
        'GET /player/{courseId}/{lessonId}?token=Y': 'HTML –ø–ª–µ–µ—Ä –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (–∏–∑ email)',
        'GET /archive/{courseId}?token=Y': 'HTML –ø–ª–µ–µ—Ä-–∞—Ä—Ö–∏–≤ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π (–ø–æ—Å–ª–µ –∫—É—Ä—Å–∞)',
        'GET /thumbnails/{courseId}/{filename}': '–ü—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ –∏–∑ R2',
        'GET /video/{courseId}/{filename}?token=xxx': '–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∏–∑ R2 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π streaming',
        'POST /webhook/purchase': 'Webhook –æ—Ç SendPulse –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ'
      },
      test_links: {
        player_learning: `{url.origin}/player/course1/week1_lesson1?token=demo123`,
        player_archive: `{url.origin}/archive/course1?token=demo123`,
        thumbnail: `{url.origin}/thumbnails/course1/week1_lesson1.jpg`,
        video: `{url.origin}/video/course1/week1_lesson1.mp4?token=demo123`
      },
      course_structure: COURSE_DATA,
      timestamp: new Date().toISOString()
    }),
    {
      headers: { 'Content-Type': 'application/json' }
    }
  );
}
"@ | Out-File -FilePath "src\handlers\api.js" -Encoding UTF8

# –°–æ–∑–¥–∞–µ–º handlers/thumbnails.js - –ø—É–±–ª–∏—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
@"
// handlers/thumbnails.js
import { createCorsResponse } from '../utils/cors.js';
import { createNotFoundResponse } from '../utils/errors.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handleThumbnails(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/');
  
  if (pathParts.length < 4) {
    return createNotFoundResponse('Invalid thumbnail path');
  }
  
  const courseId = pathParts[2];
  const thumbnailFile = pathParts[3];
  
  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }

  // –ù–∞—Ö–æ–¥–∏–º —É—Ä–æ–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ thumbnail
  let lessonData = null;
  for (const key in course.lessons) {
    if (course.lessons[key].thumbnail_file === thumbnailFile) {
      lessonData = course.lessons[key];
      break;
    }
  }

  if (!lessonData) {
    return createNotFoundResponse('Lesson thumbnail');
  }

  try {
    const object = await env.R2.get(`thumbnails/{courseId}/{lessonData.thumbnail_file}`);

    if (!object) {
      return createNotFoundResponse('Thumbnail in R2');
    }

    return createCorsResponse(object.body, {
      headers: {
        'Content-Type': object.httpMetadata?.contentType || 'image/jpeg',
        'Cache-Control': 'public, max-age=86400',
        'ETag': object.httpEtag
      }
    });

  } catch (error) {
    console.error('R2 thumbnail error:', error);
    return createNotFoundResponse('Thumbnail');
  }
}
"@ | Out-File -FilePath "src\handlers\thumbnails.js" -Encoding UTF8

# –°–æ–∑–¥–∞–µ–º handlers/video.js - –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ —Å streaming
@"
// handlers/video.js
import { createCorsResponse } from '../utils/cors.js';
import { createNotFoundResponse, createUnauthorizedResponse, createBadRequestResponse } from '../utils/errors.js';
import { validateTokenFormat } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handleVideo(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/');
  
  if (pathParts.length < 4) {
    return createBadRequestResponse('Invalid video path format');
  }
  
  const courseId = pathParts[2];
  const videoFile = pathParts[3];
  const token = url.searchParams.get('token');

  if (!token) {
    return createUnauthorizedResponse('Token required');
  }

  if (!validateTokenFormat(token)) {
    return createUnauthorizedResponse('Invalid token format');
  }

  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }

  // –ù–∞—Ö–æ–¥–∏–º —É—Ä–æ–∫ –ø–æ –∏–º–µ–Ω–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞
  let lessonData = null;
  for (const key in course.lessons) {
    if (course.lessons[key].video_file === videoFile) {
      lessonData = course.lessons[key];
      break;
    }
  }

  if (!lessonData) {
    return createNotFoundResponse('Video');
  }

  // TODO: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫—É—Ä—Å—É —á–µ—Ä–µ–∑ SendPulse API

  try {
    // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞
    const videoPath = `videos/{courseId}/{lessonData.video_file}`;
    const object = await env.R2.head(videoPath);
    
    if (!object) {
      return createNotFoundResponse('Video in R2');
    }

    const fileSize = object.size;
    const range = request.headers.get('range');

    // HTTP Range requests –¥–ª—è streaming
    if (range) {
      const parts = range.replace(/bytes=/, '').split('-');
      const start = parseInt(parts[0], 10);
      const end = parts[1] ? parseInt(parts[1], 10) : fileSize - 1;
      const chunkSize = end - start + 1;

      const rangedObject = await env.R2.get(videoPath, {
        range: {
          offset: start,
          length: chunkSize
        }
      });

      if (!rangedObject) {
        return new Response('Range Not Satisfiable', { status: 416 });
      }

      return createCorsResponse(rangedObject.body, {
        status: 206,
        headers: {
          'Content-Type': 'video/mp4',
          'Content-Length': chunkSize.toString(),
          'Content-Range': `bytes {start}-{end}/{fileSize}`,
          'Accept-Ranges': 'bytes',
          'Cache-Control': 'no-cache'
        }
      });
    }

    // –ü–æ–ª–Ω–æ–µ –≤–∏–¥–µ–æ –±–µ–∑ range
    const fullObject = await env.R2.get(videoPath);
    return createCorsResponse(fullObject.body, {
      headers: {
        'Content-Type': 'video/mp4',
        'Content-Length': fileSize.toString(),
        'Accept-Ranges': 'bytes',
        'Cache-Control': 'no-cache',
        'ETag': object.httpEtag
      }
    });

  } catch (error) {
    console.error('Video access error:', error);
    return createNotFoundResponse('Video');
  }
}
"@ | Out-File -FilePath "src\handlers\video.js" -Encoding UTF8

# –°–æ–∑–¥–∞–µ–º handlers/webhooks.js - SendPulse integration
@"
// handlers/webhooks.js
import { createCorsResponse } from '../utils/cors.js';
import { createBadRequestResponse } from '../utils/errors.js';
import { generateSimpleToken } from '../utils/token.js';

export async function handleWebhooks(request, env, ctx) {
  try {
    const webhook = await request.json();

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userToken = generateSimpleToken(
      webhook.email || 'test@example.com',
      webhook.course_id || 'course1'
    );

    // TODO: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –≤ SendPulse —á–µ—Ä–µ–∑ API
    // await updateSendPulseContact(webhook.email, {
    //   access_token: userToken,
    //   purchase_date: new Date().toISOString(),
    //   subscription_type: webhook.subscription_type
    // });

    return createCorsResponse(
      JSON.stringify({
        status: 'success',
        message: 'Webhook processed successfully',
        user_token: userToken,
        received_data: webhook,
        note: 'Token will be sent in first course email'
      }),
      {
        headers: { 'Content-Type': 'application/json' }
      }
    );

  } catch (error) {
    console.error('Webhook processing error:', error);
    return createBadRequestResponse('Invalid webhook data');
  }
}
"@ | Out-File -FilePath "src\handlers\webhooks.js" -Encoding UTF8

Write-Host "‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã!" -ForegroundColor Green

# –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø–ª–µ–µ—Ä–æ–≤ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç—ã–µ)
@"
// handlers/player-learning.js - –ø–ª–µ–µ—Ä –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (–∏–∑ email)
import { createCorsResponse } from '../utils/cors.js';
import { createNotFoundResponse, createUnauthorizedResponse } from '../utils/errors.js';
import { validateTokenFormat } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handlePlayerLearning(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/');
  
  if (pathParts.length < 4) {
    return createNotFoundResponse('Invalid player path');
  }
  
  const courseId = pathParts[2] || 'course1';
  const lessonId = pathParts[3] || 'week1_lesson1';
  const token = url.searchParams.get('token') || 'demo-token-123';
  const email = url.searchParams.get('email') || 'demo@mastermarat.com';

  if (!validateTokenFormat(token)) {
    return createUnauthorizedResponse('Invalid token');
  }

  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }

  const lessonData = course.lessons[lessonId];
  if (!lessonData) {
    return createNotFoundResponse('Lesson');
  }

  // TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ R2
  let contentData = {
    display_title: null,
    description_points: ["–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –æ—Å—Ç–µ–æ–ø–∞—Ç–∏–∏", "–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π", "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"],
    important_notes: ["–í—ã–ø–æ–ª–Ω—è–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ", "–ü—Ä–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"],
    additional_resources: []
  };

  // –ü—Ä–æ—Å—Ç–æ–π HTML –ø–ª–µ–µ—Ä (–ø–æ–∑–∂–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –≤ templates/)
  const playerHTML = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterMarat - {lessonData.title}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
        .header { background: #2E8B57; color: white; padding: 20px; text-align: center; }
        .video-container { max-width: 800px; margin: 20px auto; background: white; border-radius: 8px; overflow: hidden; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .content { padding: 20px; }
        .watermark { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ {lessonData.title}</h1>
        <p>–ö—É—Ä—Å: {course.title} ‚Ä¢ –†–µ–∂–∏–º: –û–±—É—á–µ–Ω–∏–µ</p>
    </div>
    
    <div class="video-container">
        <div class="video-wrapper">
            <div class="watermark">{email}</div>
            <video controls playsinline>
                <source src="/video/{courseId}/{lessonData.video_file}?token={token}" type="video/mp4">
            </video>
        </div>
        
        <div class="content">
            <h2>{lessonData.title}</h2>
            <h3>–í —ç—Ç–æ–º —É—Ä–æ–∫–µ:</h3>
            <ul>
                {contentData.description_points.map(point => `<li>{point}</li>`).join('')}
            </ul>
            
            {contentData.important_notes.length > 0 ? `
            <div style="background: #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <h3>‚ö†Ô∏è –í–∞–∂–Ω–æ:</h3>
                {contentData.important_notes.map(note => `<p>{note}</p>`).join('')}
            </div>
            ` : ''}
        </div>
    </div>

    <script>
        console.log('Learning mode player loaded for: {courseId}/{lessonId}');
    </script>
</body>
</html>`;

  return createCorsResponse(playerHTML, {
    headers: {
      'Content-Type': 'text/html;charset=UTF-8',
      'Cache-Control': 'no-cache'
    }
  });
}
"@ | Out-File -FilePath "src\handlers\player-learning.js" -Encoding UTF8

@"
// handlers/player-archive.js - –ø–ª–µ–µ—Ä-–∞—Ä—Ö–∏–≤ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π (–ø–æ—Å–ª–µ –∫—É—Ä—Å–∞)
import { createCorsResponse } from '../utils/cors.js';
import { createNotFoundResponse, createUnauthorizedResponse } from '../utils/errors.js';
import { validateTokenFormat } from '../utils/token.js';
import { COURSE_DATA } from '../config/courses.js';

export async function handlePlayerArchive(request, env, ctx) {
  const url = new URL(request.url);
  const pathParts = url.pathname.split('/');
  
  if (pathParts.length < 3) {
    return createNotFoundResponse('Invalid archive path');
  }
  
  const courseId = pathParts[2] || 'course1';
  const token = url.searchParams.get('token') || 'demo-token-123';

  if (!validateTokenFormat(token)) {
    return createUnauthorizedResponse('Invalid token');
  }

  const course = COURSE_DATA[courseId];
  if (!course) {
    return createNotFoundResponse('Course');
  }

  // TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞—Ä—Ö–∏–≤—É (–∑–∞–≤–µ—Ä—à–∏–ª –∫—É—Ä—Å)

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Ä–æ–∫–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  const lessonsList = Object.entries(course.lessons).map(([lessonId, lesson]) => {
    return `
      <div class="lesson-item">
        <a href="/video/{courseId}/{lesson.video_file}?token={token}" target="_blank">
          <img src="/thumbnails/{courseId}/{lesson.thumbnail_file}" alt="{lesson.title}" style="width: 120px; height: 68px; object-fit: cover;">
          <span>{lesson.title}</span>
        </a>
      </div>
    `;
  }).join('');

  const archiveHTML = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterMarat - –ê—Ä—Ö–∏–≤ –∫—É—Ä—Å–∞ {course.title}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
        .header { background: #3D968C; color: white; padding: 20px; text-align: center; }
        .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .lessons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .lesson-item { background: white; border-radius: 8px; padding: 15px; }
        .lesson-item a { text-decoration: none; color: #333; display: flex; align-items: center; gap: 15px; }
        .lesson-item:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö –ê—Ä—Ö–∏–≤ –∫—É—Ä—Å–∞: {course.title}</h1>
        <p>–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —É—Ä–æ–∫–∞–º –∫—É—Ä—Å–∞</p>
    </div>
    
    <div class="container">
        <h2>–í—Å–µ —É—Ä–æ–∫–∏ –∫—É—Ä—Å–∞ ({Object.keys(course.lessons).length} —É—Ä–æ–∫–æ–≤)</h2>
        <div class="lessons-grid">
            {lessonsList}
        </div>
    </div>

    <script>
        console.log('Archive mode player loaded for course: {courseId}');
    </script>
</body>
</html>`;

  return createCorsResponse(archiveHTML, {
    headers: {
      'Content-Type': 'text/html;charset=UTF-8',
      'Cache-Control': 'no-cache'
    }
  });
}
"@ | Out-File -FilePath "src\handlers\player-archive.js" -Encoding UTF8

Write-Host "‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã!" -ForegroundColor Green
Write-Host "" -ForegroundColor White
Write-Host "üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" -ForegroundColor Cyan
Write-Host "‚Ä¢ handlers/api.js - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API" -ForegroundColor Yellow
Write-Host "‚Ä¢ handlers/thumbnails.js - –ø—É–±–ª–∏—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" -ForegroundColor Yellow
Write-Host "‚Ä¢ handlers/video.js - –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ —Å streaming" -ForegroundColor Yellow
Write-Host "‚Ä¢ handlers/player-learning.js - –ø–ª–µ–µ—Ä –¥–ª—è –æ–±—É—á–µ–Ω–∏—è" -ForegroundColor Yellow
Write-Host "‚Ä¢ handlers/player-archive.js - –ø–ª–µ–µ—Ä-–∞—Ä—Ö–∏–≤ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π" -ForegroundColor Yellow
Write-Host "‚Ä¢ handlers/webhooks.js - SendPulse integration" -ForegroundColor Yellow
Write-Host "" -ForegroundColor White
Write-Host "üéØ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏ —à–∞–±–ª–æ–Ω—ã." -ForegroundColor Green